<% provide(:title, t(".title", portfolio_title: @portfolio.title)) %>
<% provide(:submit_text, t("btn.create")) %>
<div class="portfolio-show">
  <main class="portfolio-whole <%= "before-login" unless user_signed_in? %>">
    <%= render "shared/portfolio_info", portfolio: @portfolio %>
    <% if @portfolio.image? %>
      <%= image_tag @portfolio.image.url, class: "image" %>
    <% end %>
    <div class="content"><%= @portfolio.content %></div>
    <hr>
    <div class="progress-user">
      <%= link_to set_user_image(@portfolio.user), @portfolio.user %>
      <div class="user-info">
        <%= link_to @portfolio.user.username, @portfolio.user %>
        <div class="profile"><%= @portfolio.user.profile %></div>
        <%= render "users/follow_form", user: @portfolio.user if user_signed_in? %>
      </div>
    </div>
    <div class="progress-whole">
      <h2 class="py-2">プログレス <%= link_to "##{get_number(@portfolio, @progress)}", portfolio_progress_path(@portfolio, @progress), class: "id" %></h2>
      <div class="progress-header">
        <% if @progress.has_any_evaluations? %>
          <span class="average_evaluation">評価：<%= @progress.average_evaluation %></span>（<%= @progress.comments.count %> 件）
        <% end %>
        <% if current_user?(@portfolio.user) %>
          <span class="dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fas fa-cog"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
              <li>
                <%= link_to edit_portfolio_progress_path(@portfolio, @progress) do %>
                  <span><i class="fas fa-pencil-alt"></i> <%= t("btn.edit") %></span>
                <% end %>
              </li>
              <li class="dropdown-divider"></li>
              <li>
                <%= link_to portfolio_progress_path(@portfolio, @progress),
                  method: :delete, data: { confirm: t("common.delete_confirmation") } do %>
                  <span><i class="fas fa-trash-alt"></i> <%= t("btn.delete") %></span>
                <% end %>
              </li>
            </ul>
          </span>
        <% end %>
      </div>
      <div class="content"><%= @progress.content %></div>
      <% unless @comments == nil %>
        <div class="comments">
          <ol>
            <%= render @comments, portfolio: @portfolio, progress: @progress %>
          </ol>
        </div>
      <% end %>
      <% if user_signed_in? %>
        <div class="comment-form">
          <%= link_to set_user_image(@portfolio.user), @portfolio.user, class: "user-image" %>
          <strong>コメントを投稿する</strong>
          <%= render "comments/comment_form" %>
        </div>
      <% end %>
    </div>
  </main>
  <aside>
    <%= render "shared/portfolio_sidebar", portfolio: @portfolio %>
  </aside>
</div>

<% if @progress.has_any_evaluations? %>
  <script>
    $('.average_evaluation').raty({
      size: 36,
      starOff:  "<%= asset_pack_path 'images/star-off.png' %>",
      starOn : "<%= asset_pack_path 'images/star-on.png' %>",
      starHalf: "<%= asset_pack_path 'images/star-half.png' %>",
      half: true,
      readOnly: true,
      score: <%= @progress.average_evaluation %>
    });
  </script>
<% end %>
